# 13. 연산자 오버로딩: 제대로 하기

13장에서는 다음과 같은 내용을 설명한다.

- 파이썬이 다른 자료형의 피연산자로 중위 연산자를 지원하는 방법
- 다양한 자료형의 피연산자를 다루기 위한 덕 타이핑이나 명시적인 자료형 검사의 사용
- ==, >, <= 등 향상된 비교 연산자의 별난 행동
- 피연산자를 처리할 수 없다고 중위 연산자 메서드가 알려주는 방법
- +=과 같은 계산 할당 연산자의 기본 처리 방식 및 오버로딩 방법



## 13.1 연산자 오버로딩 기본 지식

- 남용되거나
- 혼란스럽게 만들거나
- 버그를 만들거나
- 예상치 못한 성능상의 병목이 될 수도 있어서

연산자 오버로딩을 혐오하는 사람도 있다.



하지만 **파이썬 오버로딩에서의 제한**을 두어 융통성, 사용성, 안정성을 적절히 유지하면 코드의 가독성이 향상되고 만족스러운 API를 구현할 수 있다.

- 파이썬 오버로딩에서의 제한
  - 내장 자료형의 연산자는 오버로딩하지 말아야 하며
  - 새로운 연산자를 생성할 수 없으며
  - is, and, or, not을 제외한 기존 연산자를 오버로딩할 수 있다



## 13.2 단항 연산자

## 13.3 벡터를 더하기 위해 + 오버로딩하기

먼저 `__neg__()`(-), `__pos__()`(+) 메서드를 구현하며 단항 연산자를 살펴보았으며, `__add__()` 메서드가 지원하는 + 중위 연산자를 살펴보았다.

- 단항 연산자와 중위 연산자는 결코 피연산자를 변경하면 안 되며, 새로운 객체를 생성해서 결과를 반환해야 한다.
- 다른 자료형과의 연산을 지원할 때는 예외를 발생시키지 않고 `NotImplemented` 특별값을 반환함으로써 파이썬 인터프리터가 그 연산자의 **역순 메서드**를 호출해볼 수 있게 해줘야 한다.
  - NotImplemented와 NotImplementedError는 다른 것이다.
    - NotImplemented: 중위 연산자가 주어진 피연산자를 처리할 수 없을 때 파이썬 인터프리터에 '반환'하는 특별한 싱글턴 값
    - NotImplementedError: 서브클래스에서 반드시 오버라이드해야 함을 알려주기 위해 추상클래스의 메서드 스텁에서 '발생'시키는 예외
  - 역순 메서드
    - '반사(righthand)' 또는 '역순(reversed)', 필자는 역순 특별 메서드라고 부르는 것을 선호한다.
- [그림 13-1]의 플로차트로 파이썬이 중위 연산자를 처리하는 알고리즘을 정리했다.



## 13.4 벡터를 스칼라와 곱하기 위해 * 오버로딩하기

서로 다른 자료형의 피연산자를 혼합해서 사용하도록 허용하려면, 처리할 수 없는 자료형을 탐지해야 한다. 13장에서는 덕 타이핑과 명시적인 자료형 검사 방법을 사용했다.

- 덕 타이핑은 일단 연산을 수행한 후 TypeError 예외가 발생하면 이 예외를 잡아서 처리한다.
- 명시적 자료형 검사 방법은 isinstance() 함수를 사용한다.

덕 타이핑은 융통성이 높지만, 명시적인 자료형 검사는 코드의 의도를 명확히 할 수 있다.

isinstance() 함수를 사용할 때는 구상 클래스가 아닌 추상 클래스를 이용해서 isinstance(scalar, numbers.Real)과 같이 검사했다. 
추상 클래스를 사용하면 융통성과 안전을 적절히 보장할 수 있다. 기존 또는 향후 사용자가 정의한 자료형이 ABC의 실제 또는 가상 서브클래스로 선언될 수 있기 때문이다.



## 13.5 향상된 비교 연산자

향상된 비교 연산자의 오버로딩에 대해 설명한다.

== 연산자는 `__eq__()` 메서드로 지원하며, 파이썬은 object 기저 클래스에서 상속한 `__ne__()` 메서드를 이용해서 != 연산자를 적절히 지원한다는 사실을 알게 되었다.

파이썬이 >, <, >=, <= 연산자를 평가할 때는 역순 메서드를 선택하는 논리가 약간 다르다.

- [표 13-2] == 연산자는 정방향과 역순을 실행하기 위해 인수만 바꿔서 동일한 `__eq__()` 메서드를 호출하지만,
  정방향으로 `__gt__()` 메서드를 호출하는 경우, 역순으로 인수를 바꿔서 `__lt__()` 메서드를 호출한다.
- ==와 != 연산자의 경우에는 특별히 최종적인 수단으로 객체의 ID를 비교하므로 결코 에러가 발생하지 않는다.



## 13.6 복합 할당 연산자

파이썬에서는 기본적으로일반적인 연산자로 처리하고 나서 할당한다. 즉, a+=b는 a=a+b로 평가한다. 중위 연산자는 새로운 객체를 생성하므로 가변이나 불변 자료형 모두에 사용할 수 있다.

`__iadd__()` 등의 인플레이스 연산자 메서드를 정의한 경우, a+=b를 계산하기 위해 정의된 메서드가 호출된다. 인플레이스 연산자는 새로운 객체를 생성하지 않고 왼쪽에 나온 피연산자를 직접 변경한다. 

피연산자를 변경하는 특별 메서드는 불변 자료형에서는 구현하면 안된다.(당연)

가변 객체의 경우 += 연산자에 대한 `__iadd__()` 특별 메서드를 직접 구현함으로써(인플레이스) 왼쪽에 나오는 피연산자의 값을 직접 변경할 수 있다. 

일반적으로 + 연산자는 동일한 자료형의 객체 두 개를 요구하지만, += 연산자는 모든 반복형을 오른쪽 피연산자로 사용할 수 있다. 

